<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Disconnect Detection Test</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
    }
    .test-section {
      margin: 20px 0;
      padding: 15px;
      border: 1px solid #ddd;
      border-radius: 5px;
    }
    .test-section h3 {
      margin-top: 0;
    }
    button {
      padding: 10px 20px;
      margin: 5px;
      cursor: pointer;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
    }
    button:hover {
      background-color: #45a049;
    }
    button:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
    }
    .log {
      background-color: #f5f5f5;
      padding: 10px;
      margin-top: 10px;
      border-radius: 4px;
      max-height: 300px;
      overflow-y: auto;
      font-family: monospace;
      font-size: 12px;
    }
    .log-entry {
      margin: 5px 0;
      padding: 5px;
      border-left: 3px solid #4CAF50;
      background-color: white;
    }
    .log-entry.error {
      border-left-color: #f44336;
    }
    .log-entry.warning {
      border-left-color: #ff9800;
    }
    .status {
      display: inline-block;
      padding: 5px 10px;
      border-radius: 3px;
      font-weight: bold;
      margin-left: 10px;
    }
    .status.online {
      background-color: #4CAF50;
      color: white;
    }
    .status.offline {
      background-color: #f44336;
      color: white;
    }
  </style>
</head>
<body>
  <h1>Player Disconnect Detection Test</h1>
  
  <div class="test-section">
    <h3>Test Setup</h3>
    <p>This page tests the player disconnect detection system.</p>
    <div>
      <label>Room ID: <input type="text" id="roomId" value="test-room-123" /></label>
      <label>Player ID: <input type="text" id="playerId" value="test-player-456" /></label>
    </div>
  </div>

  <div class="test-section">
    <h3>PresenceTracker Tests</h3>
    <button id="testRegister">Register Player</button>
    <button id="testUnregister">Unregister Player</button>
    <button id="testIsOnline">Check If Online</button>
    <div>
      <span>Status:</span>
      <span id="presenceStatus" class="status">Unknown</span>
    </div>
  </div>

  <div class="test-section">
    <h3>DisconnectDetector Tests</h3>
    <button id="testStartMonitoring">Start Monitoring</button>
    <button id="testStopMonitoring">Stop Monitoring</button>
    <button id="testCheckStale">Check Stale Connections</button>
    <button id="testGetPlayerCount">Get Active Player Count</button>
    <div>
      <span>Active Players:</span>
      <span id="playerCount">-</span>
    </div>
  </div>

  <div class="test-section">
    <h3>DisconnectNotifier Tests</h3>
    <button id="testNotifyDisconnect">Notify Player Disconnected</button>
    <button id="testNotifyTerminating">Notify Room Terminating</button>
    <button id="testNotifyUnstable">Notify Connection Unstable</button>
  </div>

  <div class="test-section">
    <h3>Test Log</h3>
    <button id="clearLog">Clear Log</button>
    <div id="testLog" class="log"></div>
  </div>

  <script type="module">
    import { db } from './js/firebase-config.js';
    import { PresenceTracker } from './js/presence-tracker.js';
    import { DisconnectDetector } from './js/disconnect-detector.js';
    import { DisconnectNotifier } from './js/disconnect-notifier.js';
    import { ref, set } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

    // Initialize components
    const presenceTracker = new PresenceTracker(db);
    const disconnectDetector = new DisconnectDetector(db, null, null);
    const notifier = new DisconnectNotifier();
    disconnectDetector.setNotifier(notifier);

    // Helper functions
    function log(message, type = 'info') {
      const logDiv = document.getElementById('testLog');
      const entry = document.createElement('div');
      entry.className = `log-entry ${type}`;
      entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
      logDiv.appendChild(entry);
      logDiv.scrollTop = logDiv.scrollHeight;
      console.log(message);
    }

    function getRoomId() {
      return document.getElementById('roomId').value;
    }

    function getPlayerId() {
      return document.getElementById('playerId').value;
    }

    async function setupTestPlayer() {
      const roomId = getRoomId();
      const playerId = getPlayerId();
      
      // Create test player in Firebase
      const playerRef = ref(db, `rooms/${roomId}/players/${playerId}`);
      await set(playerRef, {
        name: 'Test Player',
        score: 5000,
        joinedAt: Date.now()
      });
      
      log('Test player created in Firebase');
    }

    // PresenceTracker Tests
    document.getElementById('testRegister').addEventListener('click', async () => {
      try {
        await setupTestPlayer();
        const result = await presenceTracker.registerPlayer(getPlayerId(), getRoomId());
        if (result.success) {
          log('✓ Player registered successfully', 'info');
          document.getElementById('presenceStatus').textContent = 'Online';
          document.getElementById('presenceStatus').className = 'status online';
        } else {
          log(`✗ Registration failed: ${result.error}`, 'error');
        }
      } catch (error) {
        log(`✗ Error: ${error.message}`, 'error');
      }
    });

    document.getElementById('testUnregister').addEventListener('click', async () => {
      try {
        await presenceTracker.unregisterPlayer(getPlayerId(), getRoomId());
        log('✓ Player unregistered successfully', 'info');
        document.getElementById('presenceStatus').textContent = 'Offline';
        document.getElementById('presenceStatus').className = 'status offline';
      } catch (error) {
        log(`✗ Error: ${error.message}`, 'error');
      }
    });

    document.getElementById('testIsOnline').addEventListener('click', async () => {
      try {
        const isOnline = await presenceTracker.isPlayerOnline(getPlayerId(), getRoomId());
        log(`✓ Player online status: ${isOnline}`, 'info');
        document.getElementById('presenceStatus').textContent = isOnline ? 'Online' : 'Offline';
        document.getElementById('presenceStatus').className = `status ${isOnline ? 'online' : 'offline'}`;
      } catch (error) {
        log(`✗ Error: ${error.message}`, 'error');
      }
    });

    // DisconnectDetector Tests
    document.getElementById('testStartMonitoring').addEventListener('click', () => {
      try {
        disconnectDetector.startMonitoring(getRoomId());
        log('✓ Started monitoring room', 'info');
      } catch (error) {
        log(`✗ Error: ${error.message}`, 'error');
      }
    });

    document.getElementById('testStopMonitoring').addEventListener('click', () => {
      try {
        disconnectDetector.stopMonitoring(getRoomId());
        log('✓ Stopped monitoring room', 'info');
      } catch (error) {
        log(`✗ Error: ${error.message}`, 'error');
      }
    });

    document.getElementById('testCheckStale').addEventListener('click', async () => {
      try {
        await disconnectDetector.checkStaleConnections(getRoomId());
        log('✓ Checked for stale connections', 'info');
      } catch (error) {
        log(`✗ Error: ${error.message}`, 'error');
      }
    });

    document.getElementById('testGetPlayerCount').addEventListener('click', async () => {
      try {
        const count = await disconnectDetector.getActivePlayerCount(getRoomId());
        log(`✓ Active player count: ${count}`, 'info');
        document.getElementById('playerCount').textContent = count;
      } catch (error) {
        log(`✗ Error: ${error.message}`, 'error');
      }
    });

    // DisconnectNotifier Tests
    document.getElementById('testNotifyDisconnect').addEventListener('click', () => {
      notifier.notifyPlayerDisconnected('Test Player');
      log('✓ Displayed disconnect notification', 'info');
    });

    document.getElementById('testNotifyTerminating').addEventListener('click', () => {
      notifier.notifyRoomTerminating();
      log('✓ Displayed terminating notification', 'warning');
    });

    document.getElementById('testNotifyUnstable').addEventListener('click', () => {
      notifier.notifyConnectionUnstable('Test Player');
      log('✓ Displayed unstable connection notification', 'warning');
    });

    // Clear log
    document.getElementById('clearLog').addEventListener('click', () => {
      document.getElementById('testLog').innerHTML = '';
    });

    // Initial log
    log('Test page loaded. Ready to test disconnect detection system.');
  </script>
</body>
</html>
